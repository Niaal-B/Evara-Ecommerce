{% load static %}
<style>
    p{
        color: #ad252586;
    }
</style>
<!DOCTYPE html>
<html lang="en">
<head>
    
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Dashboard</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="{% static 'admin/vendors/mdi/css/materialdesignicons.min.css' %}">
    <link rel="stylesheet" href="{% static 'admin/vendors/css/vendor.bundle.base.css' %}">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <link rel="stylesheet" href="{% static 'admin/vendors/jvectormap/jquery-jvectormap.css' %}">
    <link rel="stylesheet" href="{% static 'admin/vendors/flag-icon-css/css/flag-icon.min.css' %}">
    <link rel="stylesheet" href="{% static 'admin/vendors/owl-carousel-2/owl.carousel.min.css' %}">
    <link rel="stylesheet" href="{% static 'admin/vendors/owl-carousel-2/owl.theme.default.min.css' %}">
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="{% static 'admin/css/style.css' %}">
    <!-- End layout styles -->
    <link rel="shortcut icon" href="{% static 'admin/images/favicon.png' %}" />
</head>
<body>
    <div class="container-scroller">
        {% include 'admin/sidebar.html' %}
        <div class="container-fluid page-body-wrapper">
       
            
            
            {% include 'admin/navbar.html' %}
            <div class="main-panel">
                <div class="content-wrapper">

                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary" data-filter="today">Today</button>
                                        <button type="button" class="btn btn-outline-primary" data-filter="week">This Week</button>
                                        <button type="button" class="btn btn-outline-primary" data-filter="month">This Month</button>
                                        <!-- <button type="button" class="btn btn-outline-primary" data-filter="custom">Custom Range</button> -->
                                    </div>
                                    <div id="customDateRange" style="display: none;" class="mt-3">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <input type="date" id="startDate" class="form-control" placeholder="Start Date">
                                            </div>
                                            <div class="col-md-4">
                                                <input type="date" id="endDate" class="form-control" placeholder="End Date">
                                            </div>
                                            <div class="col-md-4">
                                                <button type="button" class="btn btn-primary" id="applyCustomDate">Apply</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Active Users</h4>
                                    <h1 id="activeUserCount">0</h1>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Total Revenue</h4>
                                    <h1 id="totalRevenue">0</h1>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Total Orders</h4>
                                    <h1 id="totalOrders">0</h1>
                                </div>
                            </div>
                        </div>
                        
                        

                    </div>

                    <div class="row" style="margin-top: 15px;" >

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Orders in Progress</h4>
                                    <h1 id="ordersInProgress">0</h1>
                                </div>
                            </div>
                        </div>


                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Total Coupon discount</h4>
                                    <h1 id="coupondiscount">0</h1>
                                </div>
                            </div>
                        </div>


                        <div class="col-md-4" >
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Total product discount</h4>
                                    <h1 id="productdiscount">0</h1>
                                </div>
                            </div>
                        </div>





                    </div>




                    <div class="row">
                        <div class="col-md-6 chart" style="margin-top: 20px;">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Top-Selling Products</h4>
                                    <canvas id="topSellingProductsChart" width="400" height="400"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 chart" style="margin-top: 20px;">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Category-Wise Sales</h4>
                                    <div style="width: 500px; height: 460px; margin: auto;">
                                        <canvas id="categorySalesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                           
                        </div>
                    </div>

                    
                    
   
                </div>
                    
                </div>
                <!-- content-wrapper ends -->
    
                <!-- Footer -->
                <!-- Footer ends -->
            </div>
            <!-- main-panel ends -->
        </div>
        <!-- page-body-wrapper ends -->
    </div>
    
    <!-- container-scroller -->
    <!-- plugins:js -->
    <script src="{% static 'admin/vendors/js/vendor.bundle.base.js' %}"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <script src="{% static 'admin/vendors/chart.js/Chart.min.js' %}"></script>
    <script src="{% static 'admin/vendors/progressbar.js/progressbar.min.js' %}"></script>
    <script src="{% static 'admin/vendors/jvectormap/jquery-jvectormap.min.js' %}"></script>
    <script src="{% static 'admin/vendors/jvectormap/jquery-jvectormap-world-mill-en.js' %}"></script>
    <script src="{% static 'admin/vendors/owl-carousel-2/owl.carousel.min.js' %}"></script>
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="{% static 'admin/js/off-canvas.js' %}"></script>
    <script src="{% static 'admin/js/hoverable-collapse.js' %}"></script>
    <script src="{% static 'admin/js/misc.js' %}"></script>
    <script src="{% static 'admin/js/settings.js' %}"></script>
    <script src="{% static 'admin/js/todolist.js' %}"></script>
    <!-- endinject -->
    <!-- Custom js for this page -->
    <script src="{% static 'admin/js/dashboard.js' %}"></script>
    <!-- End custom js for this page -->
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
   
    flatpickr("#startDate", {
        dateFormat: "Y-m-d",
        maxDate: "today" 
    });
    flatpickr("#endDate", {
        dateFormat: "Y-m-d",
        maxDate: "today"
    });
</script>


<!-- Chart.js Configuration -->
<script>
function fetchActiveUsers() {
        fetch('{% url 'active_user_count' %}')
            .then(response => response.json())
            .then(data => {
                document.getElementById('activeUserCount').innerText = data.active_users;
                console.log(data.active_users,"user lists")
            })
            .catch(error => {
                console.error('Error fetching active user count:', error);
            });
    }

    fetchActiveUsers();

    setInterval(fetchActiveUsers, 60000);

</script>


<!-- Total revenue -->

<script>
    function fetchTotalRevenue() {
        fetch('{% url 'delivered_revenue' %}')
            .then(response => response.json())
            .then(data => {
                document.getElementById('totalRevenue').innerText = `₹${data.total_revenue}`;
                console.log(data.total_revenue, "Total Revenue");
            })
            .catch(error => {
                console.error('Error fetching total revenue:', error);
            });
    }

    fetchTotalRevenue();
    setInterval(fetchTotalRevenue, 60000); 
</script>

<script>
    function fetchTotalOrders() {
        fetch('{% url "total_orders" %}')
            .then(response => response.json())
            .then(data => {
                document.getElementById('totalOrders').innerText = data.total_orders;
            })
            .catch(error => {
                console.error('Error fetching total orders:', error);
            });
    }

    fetchTotalOrders();
    setInterval(fetchTotalOrders, 60000);
</script>

<script>
    function fetchcoupondiscount(){
        fetch('{% url "coupon_discount" %}').then(response => response.json())
        .then(data => {
            document.getElementById('coupondiscount').innerText = data.total_coupon_discount
        })
        .catch(error => {
                console.error('Error fetching coupon discount:', error);
            });
    }

    fetchcoupondiscount();
    setInterval(fetchcoupondiscount, 60000);
</script>


<script>
function fetchofferdiscount(){
    fetch('{% url 'offer_discount' %}').then(response => response.json()
    .then(data => {
    document.getElementById('productdiscount').innerText = data.order_item_discount
}).catch(error => {
                console.error('Error fetching coupon discount:', error);
            }) )
}

fetchofferdiscount()
setInterval(fetchofferdiscount, 60000);
</script>

<script>
    function fetchOrdersInProgress() {
        fetch('{% url "orders_in_progress" %}')
            .then(response => response.json())
            .then(data => {
                document.getElementById('ordersInProgress').innerText = data.orders_in_progress;
            })
            .catch(error => {
                console.error('Error fetching orders in progress:', error);
            });
    }

    
    fetchOrdersInProgress();

   
    setInterval(fetchOrdersInProgress, 60000);
</script>

<!-- top selling product chart -->
<script>
    function fetchTopSellingProducts() {
        fetch('{% url "top_selling_products" %}') 
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('topSellingProductsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.product_names.map((name, index) => `P${index + 1}`),  
                         datasets: [{
                            label: 'Quantity Sold',
                            data: data.quantities,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 206, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(153, 102, 255, 0.2)',
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (tooltipItem) {
                                      
                                        const productName = data.product_names[tooltipItem.dataIndex];
                                        const quantity = tooltipItem.raw;
                                        return `${productName}: ${quantity}`;
                                    }
                                }
                            },
                            legend: {
                                display: false,  
                            },
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Products'
                                },
                                ticks: {
                                    maxRotation: 0,
                                    autoSkip: false  
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Quantity Sold'
                                }
                            }
                        }
                    },
                });
            })
            .catch(error => {
                console.error('Error fetching top-selling products:', error);
            });
    }

    fetchTopSellingProducts();
</script>

<style>
    p{color: rgba(34, 37, 230, 0.397);}
</style>
<script>
    fetch('{% url 'category_wise_sales' %}')
        .then(response => response.json())
        .then(data => {
            // Get the canvas context
            var ctx = document.getElementById('categorySalesChart').getContext('2d');

            // Create the pie chart with the fetched data
            var categorySalesChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.labels, 
                    datasets: [{
                        label: 'Category Sales',
                        data: data.sales_data, 
                        backgroundColor: ['rgba(91, 250, 171, 0.397)', 'rgba(0, 215, 253, 0.397)', 'rgba(174, 34, 230, 0.397)', 'rgba(34, 37, 230, 0.397)', 'rgba(255, 0, 0, 0.301)'],
                        borderColor: ['rgba(91, 250, 171, 0.397)', 'rgba(0, 215, 253, 0.397)', 'rgba(174, 34, 230, 0.397)', 'rgba(34, 37, 230, 0.397)', 'rgba(153, 102, 255, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    var category = tooltipItem.label;
                                    var sales = tooltipItem.raw;
                                    return category + ': $' + sales.toFixed(2); 
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching category sales data:', error);
        });
</script>

<!-- sales Statistics -->
<script>
   function fetchSalesStatistics() {
    fetch('{% url "sales_statistics" %}')
        .then(response => response.json())
        .then(data => {
            console.log("Received data:", data);  // Debug log
            
            const ctx = document.getElementById('categorySalesChart').getContext('2d');
            console.log('hello',window.categorySalesChart);
            
            if (window.categorySalesChart && typeof window.categorySalesChart.destroy === 'function') {
    window.categorySalesChart.destroy();
}

            window.salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates.length > 0 ? data.dates : ['No Data'],
                    datasets: [{
                        label: 'Daily Sales',
                        data: data.sales_data.length > 0 ? data.sales_data : [0],
                        fill: true,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.3,
                        pointStyle: 'circle',
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Sales Overview'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Sales: ₹${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Sales Amount (₹)'
                            },
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching sales statistics:', error);
        });
}

// Initial load
// fetchSalesStatistics();

// Refresh every 5 minutes
// setInterval(fetchSalesStatistics, 300000);
</script>


<script>
    document.addEventListener('DOMContentLoaded', function() {

        const startDatePicker = flatpickr("#startDate", {
            dateFormat: "Y-m-d",
            maxDate: "today",
            onChange: function(selectedDates, dateStr) {
                endDatePicker.set('minDate', dateStr);
            }
        });
        
        const endDatePicker = flatpickr("#endDate", {
            dateFormat: "Y-m-d",
            maxDate: "today",
            onChange: function(selectedDates, dateStr) {
                startDatePicker.set('maxDate', dateStr);
            }
        });
    

        function updateDashboard(params) {
            // Update active users
            fetch(`{% url 'active_user_count' %}${params}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('activeUserCount').innerText = data.active_users;
                });
    
            // Update total revenue
            fetch(`{% url 'delivered_revenue' %}${params}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalRevenue').innerText = `₹${data.total_revenue}`;
                });
    
            // Update total orders
            fetch(`{% url 'total_orders' %}${params}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data.total_orders,"this is total order data");
                    
                    document.getElementById('totalOrders').innerText = data.total_orders;
                });
    
            // Update orders in progress
            fetch(`{% url 'orders_in_progress' %}${params}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('ordersInProgress').innerText = data.orders_in_progress;
                });
    
                fetch(`{% url 'coupon_discount' %}${params}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data.order_discount,"this is coupon data");
                    
                    document.getElementById('coupondiscount').innerText = data.total_coupon_discount;
                });

                fetch(`{% url 'offer_discount' %}${params}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data.order_discount,"this is coupon data");
                    
                    document.getElementById('productdiscount').innerText = data.order_item_discount;
                });

            // Update charts
            function fetchTopSellingProducts(params) {
    fetch(`{% url 'top_selling_products' %}${params}`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('topSellingProductsChart').getContext('2d');
            if (window.topSellingChart) {
                window.topSellingChart.destroy();
            }
            window.topSellingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.product_names,
                    datasets: [{
                        label: 'Quantity Sold',
                        data: data.quantities,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                        ],
                        borderWidth: 1,
                    }],
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Products' } },
                        y: { beginAtZero: true, title: { display: true, text: 'Quantity Sold' } },
                    },
                },
            });
        });
}

            fetchCategoryWiseSales(params);
            fetchSalesStatistics(params);
        }
    
        // Event listeners for filter buttons
        document.querySelectorAll('[data-filter]').forEach(button => {
            button.addEventListener('click', function() {
                const filter = this.dataset.filter;
                
                // Handle custom date range display
                if (filter === 'custom') {
                    document.getElementById('customDateRange').style.display = 'flex';
                    return;
                }
                
                document.getElementById('customDateRange').style.display = 'none';
                updateDashboard(`?filter=${filter}`);
            });
        });
    
        // Event listener for custom date range
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('applyCustomDate').addEventListener('click', function() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        console.log("Start Date:", startDate);
        console.log("End Date:", endDate);

        if (startDate && endDate) {
            updateDashboard(`?start_date=${startDate}&end_date=${endDate}`);
        } else {
            alert('Please select both start and end dates');
        }
    });
});

    });
    </script>




</body>
</html>
